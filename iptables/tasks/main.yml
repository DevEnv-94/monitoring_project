---
# tasks file for iptables

- name: Update repositories cache and install iptables 
  apt:
    name: "{{ item }}"
    state: present
    update_cache: True
  with_items:
    - iptables
    - iptables-persistent



- name: Create a iptables directory if it does not exist
  ansible.builtin.file:
    path: /etc/iptables
    state: directory
    mode: '0755'


- name: Copy file mysqld_exporter.service with owner and permissions
  ansible.builtin.copy:
    src: files/rules.v4
    dest: /etc/iptables/rules.v4
    owner: root
    group: root
    mode: '0644'


- name: restore firewall state from a file
  community.general.iptables_state:
    state: restored
    path: /etc/iptables/rules.v4
  async: "{{ ansible_timeout }}"
  poll: 0



- name: Save current state of the firewall in system file
  community.general.iptables_state:
    state: saved
    path: /etc/iptables/rules.v4



- name: Make sure a service unit is running
  ansible.builtin.systemd:
    state: started
    enabled: yes
    name: netfilter-persistent.service